<!DOCTYPE html>
<html>
    <head>
        <script src="tokenator.js"></script>
        <link href="style.css" type="text/css" rel="stylesheet" /> 
    </head>
    <body class="bg-blur">
        <script>
            window.Tokenator = new window.Tokenator()
        </script>

        <!--Toast Notification-->
        <div class="toast" id="toast">
            <div class="toast-body">
            </div>
        </div>
        <div class="mainContent">
            <h1 class="header">BabbagePay</h1>
            <h4 class="subheading">Peer-to-Peer Payments</h4>
            <p>Enter your recipient's identityKey, the amount, and send your payment!</p>

            <!--Example input form-->
            <form>
                <label for="recipient">Recipient</label><br>
                <input type="text" id="recipient" name="recipient" placeholder="identity key" value=""><br>
                <label for="amount">Amount (satoshis)</label><br>
                <input type="text" id="amount" name="amount" placeholder="100"><br><br>
            </form> 

            <!--Handle submitting the payment-->
            <button class="tokenButton" onclick="{handleSubmit()}">Send</button>
            <script>
                const handleSubmit = ( async () => {
                    document.getElementById("loader").style.display = "block"
                    try {
                        let recipient = document.getElementById('recipient').value
                        let amount = Number(document.getElementById('amount').value)
                        if (!recipient || !amount) {
                            alert('Please fill out the required fields!')
                            document.getElementById("loader").style.display = "none"
                            return
                        }
                        const result = await window.Tokenator.sendMessage({ 
                            type: 'payment_inbox', 
                            amount, 
                            recipient
                        })
                        document.getElementById("loader").style.display = "none"
                        const toast = document.getElementById('toast');
                        toast.querySelector('.toast-body').innerHTML = "Payment Sent! ðŸŽ‰";
                        toast.classList.add('visible');
                    } catch (error) {
                        document.getElementById("loader").style.display = "none"
                        alert(error)
                    }
                    setTimeout(() => { location.reload() }, 1500)
                } )
            </script>

            <div id="loader" class="loader"></div>

            <!--Display new messages-->
            <h2 id="mailStatus"></h2>
            <table id="myMessages">
                <tbody id="tbody">
                    <tr>
                        <th>Sender</th>
                        <th>Amount</th>
                        <th></th>
                    </tr>
                </tbody>
            </table>

            <!--Check for new messages-->
            <script>
                let list = document.getElementById("myMessages");
                document.getElementById("loader").style.display = "none"
                list.style.display = "none"
                let newMessages = []
                const checkforNewMessages = async () => {
                    const newMessages = await window.Tokenator.listMessages({ messageBoxType: ['payment_inbox'], acknowledged: false})
                    if (!newMessages || newMessages.length === 0) {
                        document.getElementById('mailStatus').innerText = 'No new payments'
                    } else {
                        document.getElementById('mailStatus').innerText = 'Incoming Payments'
                        list.style.display = "block"
                    }
                    // newMessages = newMessages.reverse()
                    newMessages.forEach((message)=> {
                        let tblBody = document.getElementById("tbody")
                        const row = document.createElement("tr");

                        const senderCell = document.createElement("td");
                        const sender = document.createTextNode(message.sender);
                        senderCell.appendChild(sender);
                        row.appendChild(senderCell);

                        const amount = JSON.parse(message.body).amount

                        const amountCell = document.createElement("td");
                        const amountTxt = document.createTextNode(amount + ' sats');
                        amountCell.appendChild(amountTxt);
                        row.appendChild(amountCell)

                        const actionCell = document.createElement("td");

                        const acceptBtn = document.createElement("BUTTON");
                        acceptBtn.innerHTML = "Accept";
                        acceptBtn.classList.add('acceptButton');
                        acceptBtn.onclick = async () => {
                            document.getElementById("loader").style.display = "block"
                            try {
                                const result = await window.Tokenator.readMessage({
                                    messageId: message.messageId, 
                                    messageBoxType: 'payment_inbox'
                                })
                                document.getElementById("loader").style.display = "none"
                                const toast = document.getElementById('toast');
                                toast.querySelector('.toast-body').innerHTML = "Payment recieved!";
                                toast.classList.add('visible');
                            } catch (error) {
                                document.getElementById("loader").style.display = "none"
                                alert(error)
                            }
                            // Refresh the page after 2sec
                            setTimeout(() => { location.reload() }, 1500)
                        }
                        actionCell.appendChild(acceptBtn);
                        row.appendChild(actionCell);
                        tblBody.appendChild(row);
                    })
                    window.newMessages = newMessages
                }
                checkforNewMessages()
            </script>
        </div>
    </body>
</html>