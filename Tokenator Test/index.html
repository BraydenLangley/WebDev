<!DOCTYPE html>
<html>
    <head>
        <script src="tokenator.js"></script>
        <link href="style.css" type="text/css" rel="stylesheet" /> 
    </head>
    <body>
        <script>
            window.Tokenator = new window.Tokenator()
        </script>
        <div class="mainContent">
            <h1>Welcome to the PeerServ UI</h1>
            <p>This is an example website that shows how to use tokenator to interact with a PeerServ instance.</p>

            <!--Example input form-->
            <form>
                <label for="recipient">Recipient Identity Key</label><br>
                <input type="text" id="recipient" name="recipient" placeholder="identity key" value=""><br>
                <label for="tokenType">MessageBox Name</label><br>
                <input type="text" id="tokenType" name="tokenType" placeholder="token type identifier" value=""><br>
                <label for="amount">Amount to Send (satoshis)</label><br>
                <input type="text" id="amount" name="amount" placeholder="100"><br><br>
            </form> 

            <div id="loader" class="loader"></div>

            <!--Handle submitting the payment-->
            <button class="tokenButton" onclick="{handleSubmit()}">Send</button>
            <script>
                const handleSubmit = ( async () => {
                    document.getElementById("loader").style.display = "block"
                    try {
                        let recipient = document.getElementById('recipient').value
                        let amount = Number(document.getElementById('amount').value)
                        let tokenType = document.getElementById('tokenType').value
                        if (!recipient || !amount || !tokenType) {
                            alert('Please fill out the required fields!')
                            document.getElementById("loader").style.display = "none"
                            return
                        }
                        const result = await window.Tokenator.sendMessage({ 
                            type: tokenType, 
                            amount, 
                            recipient
                        })
                        document.getElementById("loader").style.display = "none"
                        alert(`${amount} satoshis sent to ${recipient}`)
                    } catch (error) {
                        document.getElementById("loader").style.display = "none"
                        alert(error)
                    }
                } )
            </script>

            <!--Display new messages-->
            <h2 id="mailStatus"></h2>
            <table id="myMessages">
                <tbody id="tbody">
                    <tr>
                        <th>Sender</th>
                        <th>MessageBox</th>
                    </tr>
                </tbody>
            </table>

            <!--Check for new messages-->
            <script>
                document.getElementById("loader").style.display = "none"
                const checkforNewMessages = async () => {
                    const newMessages = await window.Tokenator.listMessages({ acknowledged: false})
                    if (!newMessages || newMessages.length === 0) {
                        document.getElementById('mailStatus').innerText = 'No new messages'
                    } else {
                        document.getElementById('mailStatus').innerText = 'You got mail!'

                        let list = document.getElementById("myMessages");
                        // newMessages = newMessages.reverse()
                        newMessages.forEach((message)=> {
                            let tblBody = document.getElementById("tbody")
                            const row = document.createElement("tr");

                            const senderCell = document.createElement("td");
                            const sender = document.createTextNode(message.sender);
                            senderCell.appendChild(sender);
                            row.appendChild(senderCell);

                            const typeCell = document.createElement("td");
                            const type = document.createTextNode(message.type);
                            typeCell.appendChild(type);
                            row.appendChild(typeCell);

                            tblBody.appendChild(row);
                        })
                    }
                }
                checkforNewMessages()

                const receiveMessages =  async () => {
                    document.getElementById("loader").style.display = "block"
                    try {
                        const result = await window.Tokenator.receiveMessages()
                    document.getElementById("loader").style.display = "none"
                        alert('Success!')
                    } catch (error) {
                    document.getElementById("loader").style.display = "none"
                        alert(error)
                    }
                }
            </script>


            <button class="tokenButton" onclick="{receiveMessages()}">
                Receive All Tokens
            </button>
        </div>
<style>
.loader {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 50px;
  height: 50px;
  -webkit-animation: spin 2s linear infinite; /* Safari */
  animation: spin 2s linear infinite;
}

/* Safari */
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
    </body>
</html>